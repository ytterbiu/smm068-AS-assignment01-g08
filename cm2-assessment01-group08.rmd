---
title: "Computational Frameworks for Portfolio Construction and Risk Assessment"
subtitle: "SMM068 (2025-26) Group Coursework 01 - Group 08"
author:
  - "Benjamin Evans"
  - "Basmah Khan"
  - "Bong Su Kil"
  - "Ardi Wira Sudarmo"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  bookdown::html_document2:
    self_contained: true
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: hide
    theme: united
    highlight: tango
    df_print: paged
  # runtime: shiny
  bookdown::pdf_document2:
    includes:
      in_header: preamble.tex
    number_sections: true
    toc: true
    latex_engine: xelatex
    citation_package: natbib
    keep_tex: true
# fontsize: 10pt
bibliography: references.bib
---

```{=latex}
\newpage
```

```{=html}
<h1>Information</h1>

This R Markdown document was created as part of a group assignment for SMM068 at Bayes Business School, City St George's, University of London in Term 2 2025-26.

```

```{r asthetic-header, include=FALSE, echo=FALSE}
# ==============================================================================
# SMM068 Financial Economics (Subject CM2)
# Group Coursework 2025-26
# Group:        Group 08
# Authors (in alphabetical order):
#   - Benjamin Evans
#   - Basmah Khan
#   - Bong Su Kil
#   - Ardi Wira Sudarmo
# Professor:    Dr. Iqbal Owadally
# Institution:  Bayes Business School - City St George's, University of London
# Date:         TBC
# Description:  Term 2 group project for SMM068 Financial Economics
# (50% of coursework grade - 10% of module grade). The R code below
# has been exported directly from an R Markdown (.rmd) file.  Hence the knitr
# settings.
# Dependencies:
#   - TBI
# Acknowledgements
#   - TBI
# ==============================================================================

```

```{r setup-knitr, include=FALSE, echo=FALSE}
#----------------------- Initial setup (knitr settings) -----------------------#
dir.create("fig", showWarnings = FALSE)

# Defaults common to all outputs
knitr::opts_chunk$set(
  echo     = TRUE,
  message  = FALSE,
  warning  = FALSE,
  fig.align = "center",
  out.width = "100%",
  fig.path  = "fig/",
  dpi       = 300
)

# Output-specific settings
if (knitr::is_latex_output()) {
  knitr::opts_chunk$set(
    fig.width = 6,
    fig.height = 4,
    dev = "pdf",
    fig.pos = "ht",
    out.extra = ""
  )
} else {
  knitr::opts_chunk$set(
    fig.width = 6,
    fig.height = 4,
    dev = "svglite"  # or "png"
  )
}
```

```{r setup-qol, include=FALSE, echo=FALSE}
#----------------------------- Clean environment ------------------------------#
rm(list = ls()) # Remove all objects
graphics.off() # Close all graphical devices
cat("\014") # Clean console
```

```{r load-dependencies, include=FALSE, echo=FALSE}
#------------------- Load dependencies / external libraries -------------------#
library(quantmod)
library(xts) # for downloading
library(zoo) # for downloading

library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(kableExtra)
```

```{r html-app, echo=FALSE, results='asis', eval=knitr::is_html_output(), purl=FALSE}
#------------------------------ HTML link to app ------------------------------#
library(htmltools)

div(style = "background-color: #f8f9fa; padding: 20px; border: 1px solid #e9ecef; border-radius: 5px; text-align: center; margin-bottom: 30px;",
  h3("Bonus Interactive Dashboard Available"),
  p("This static report is accompanied by a live R Shiny dashboard allowing one to test different tickers, exclude specific outlier periods, and adjust bootstrap simulation parameters."),
  a(href = "https://3enji.shinyapps.io/SMM047-202526-Group07-Dashboard/",
    target = "_blank",
    class = "btn btn-primary",
    style = "background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;",
    "Launch Interactive Dashboard")
)
```

```{r custom-functions, include=FALSE, echo=FALSE}
#---------------------------- Custom QOL functions ----------------------------#
#####################################
# function: banner comments (used to to section up code)
# Usage: banner_comment("Element 1: data cleaning") -> then ctrl + v (or cmd+v)
#####################################
banner_comment <- function(text, width = 80, border = "#", fill = "-") {
  txt <- paste0(" ", text, " ")
  inner_width <- width - 2 * nchar(border)
  banner_string <- ""

  if (inner_width <= nchar(txt)) {
    banner_string <- paste0(border, txt, border)
  } else {
    pad_total <- inner_width - nchar(txt)
    pad_left <- pad_total %/% 2
    pad_right <- pad_total - pad_left

    banner_string <- paste0(
      border,
      strrep(fill, pad_left),
      txt,
      strrep(fill, pad_right),
      border
    )
  }

  cat(banner_string, "\n")
  # copy banner to allow direct pasting (requires clipr)
  clipr::write_clip(banner_string)
  # avoid [1] when printing if want to manually copy
  invisible(banner_string)
}
#####################################
# function: format p-values for text
# Usage (in-line): `r format_p_vals(ad_test_result$p.value)`
# Usage (console): format_p_vals(ad_test_result$p.value)
#####################################
format_p_vals <- function(p) {
  if (length(p) != 1L || is.na(p)) {
    stop("Error! p must be a single non-missing value")
  }
  if (p > 1) {
    stop("Error! Value greater than 1")
  }
  if (p < 0) {
    stop("Error! Value less than 0")
  }

  if (p >= 0.01) {
    paste0("= ", formatC(p, format = "f", digits = 2))
  } else if (p >= 0.001) {
    paste0("= ", formatC(p, format = "f", digits = 3))
  } else {
    "< 0.001"
  }
}
#####################################
# function: format confidence intervals for tables & text
# Usage (in-line): `r format_interval(el2_ci_normal_95[1], el2_ci_normal_95[2])`
# Usage (console): format_interval(el2_ci_normal_95[1], el2_ci_normal_95[2])
#####################################
format_interval <- function(lower, upper, digits=3) {
  paste0("[",
       formatC(lower, format = "f", digits = digits), ", ",
       formatC(upper, format = "f", digits = digits),
       "]")
}
```

# Downloading the data

```{r Q1, echo=knitr::is_html_output()}
# ==============================================================================
# Q1 5 Stocks in U.S market
# ==============================================================================

# R code goes here
# Five insurance-related stocks are chosen 
# The specific choice of stocks is flexible, as the primary objective

stocks <- c("TRV","PGR","ALL","CB","AIG")
start_date <- as.Date("2023-01-01")    # fix dates
end_date <- as.Date("2025-12-31")
getSymbols(stocks, src = "yahoo", from = start_date, to = end_date)

# Q1-1 Adjusted close extract

prices <- data.frame(
  Date = index(Ad(TRV)),
  TRV = coredata(Ad(TRV)),
  PGR = coredata(Ad(PGR)),
  ALL = coredata(Ad(ALL)),
  CB  = coredata(Ad(CB)),
  AIG = coredata(Ad(AIG))  
)

head(prices)
tail(prices)

write.csv(prices, "Q1.csv", row.names=FALSE)

```

Download 3 years of daily prices for 5 U.S. stocks. [5 marks]

- pdf : Explain precisely which information resource you used, provide a URL if
  available, state the name and ticker code for the stocks, state the date
  range, state which price label you used.
- xlsx: The data should appear in worksheet “Q1” over 6 columns, the first
  column being the date.
- [Total: 5 marks (8.3%)]

**Answer:**

- **Information resource used:** Yahoo finance

- **URL if available:** 
 https://finance.yahoo.com

- **Name and ticker code for stocks**
  - TRV (The Travelers Companies, Inc.) 
  - PGR (Progressive Corporation)  
  - ALL (Allstate Corporation)  
  - CB (Chubb Limited)  
  - AIG (American International Group, Inc.) 

- **Date range:**
 1 January 2023 – 31 December 2025

- **Price label used:** 
 Adjusted closing price

```{=latex}
\newpage
```

# Portfolio optimisation

TBI

```{=latex}
\newpage
```

# Asset risk theory {#qthree}

```{r Q3, echo=knitr::is_html_output(), results = 'hide'}
# R code goes here
set.seed(1234)
n_sim <- 1e6

Z <- rbinom(n_sim, size = 1, prob = 0.2)
R2 <- rnorm(n_sim, mean = ifelse(Z==1, 0.3, 0.0), sd = 0.1)

mean(R2)
var(R2)
```

Consider 2 assets with random returns. Asset 1 has a Normally distributed return
$R_{1}$ with mean 6% and variance 2.44% and asset 2 has a random return $R_{2}$
given by,

$$
R_{1} \sim \mathcal{N}(\mu=0.06, \sigma^{2}=0.0244),
\quad
R_{2}
\sim
\begin{cases}
\mathcal{N}(\mu=0.0, \, \sigma^{2}=0.1^{2}) \quad &\text{w.p. } 0.8\\
\mathcal{N}(\mu=0.3, \, \sigma^{2}=0.1^{2}) &\text{w.p. } 0.2
\end{cases}
$$

where w.p. means "with probability".

## Calculate $\mathbb{E}[R_{2}]$ and $\mathrm{Var}(R_{2})$. {#qthreePtA}

_[5 marks]_

<!-- prettier-ignore -->
\begin{align*} 
\mathbb{E}[R_{2}] & = (0\times 0.8) + (0.3\times 0.2) \\ 
& = \underline{\mathbf{0.06}} 
\end{align*}

Using law of total variance

$$
R_{2} \sim \begin{cases}
X\mid Z =1 &\sim \mathcal{N}(\mu=0.0, \, \sigma^{2}=0.1^{2}) \quad \text{w.p. } 0.8\\
X\mid Z =2 &\sim \mathcal{N}(\mu=0.3, \, \sigma^{2}=0.1^{2}) \quad \text{w.p. } 0.2
\end{cases}
$$

<!-- prettier-ignore -->
\begin{align*} 
\text{Var}(R_{2}) & = \mathbb{E}[\text{Var}(X\mid Z)]
+\text{Var}(\mathbb{E}[X\mid Z]) \\ \\ 
\mathbb{E}[\text{Var}(X\mid Z)] & = p_{1}
\sigma_{1}^{2} + p_{2} \sigma_{2}^{2} \\ 
& = (0.8)(0.1^2) + (0.2)(0.1^2) \\ 
& = 0.01 \\ \text{Var}(\mathbb{E}[X\mid Z]) & = p(1-p)(\mu_{1}-\mu_{2})^{2} \\ 
& = (0.8)(0.2)(-0.3)^{2} \\ 
& = 0.0144 \\ \\ 
\to \text{Var}(R_{2}) & = 0.01 + 0.0144
\\ & = \underline{\mathbf{0.0244}}
\end{align*}

Answers: $\mathbb{E}[R_{2}]$ = **0.06**, $\text{Var}(R_{2})=$ **0.0244**

## Use **R** to estimate $\mathbb{E}[R_{2}]$ and $\mathrm{Var}(R_{2})$. {#qthreePtB}

_[5 marks]_

We simulated `r formatC(n_sim, format = "fg", digits = 3, big.mark = ",")`
values of $R_{2}$. This resulted in a mean value of
**`r formatC(mean(R2), format = "fg", digits = 5, small.mark = " ", small.interval = 3L)`**
and variance of
**`r formatC(var(R2), format = "fg", digits = 5, small.mark = " ", small.interval = 3L)`**.

- BE note: include brief detail here about the R commands used `rbinom` and
`rnorm`.

As expected, these are very similar to the theoretical values of 0.06 and 0.0244
calculated in \@ref(qthreePtA).

## Calculate the shortfall probabilities for asset 1, assuming a benchmark return of

### 0%,

### -10%.

_[2 marks]_

## Repeat part Q3c above for asset 2.

_[4 marks]_

## Use **R** to plot the probability density functions of returns for assets 1 and 2 on the same axes.

_[3 marks]_

## Use **R** to plot the cumulative density functions of returns for assets 1 and 2 on the same axes.

_[2 marks]_

## Based on your answers to parts Q3a–Q3f above, comment on the risk involved in asset 2, compared to asset 1.

_[4 marks]_

- pdf : Show all final numerical answers in **bold**. Include all working. Paste
  the plots. Write your answer to part Q3g on no more than 5 lines.
- R: Computations and plotting should be done in R (code chunk with heading
  “Q3”).
- [Total: 25 marks (41.7%)]

```{=latex}
\newpage
```

<!-- # Conclusions

TBI -->

<!-- ```{=html} -->
<!-- # References -->
<!-- <div id="refs"></div> -->
<!-- ``` -->

<!-- ```{=latex} -->
<!-- \bibliography{references.bib} -->
<!-- ``` -->

```{=latex}
\newpage
\section*{Appendices}
\addcontentsline{toc}{section}{Appendices}
```

# (APPENDIX) Appendices {-}

# TBI

# Supplemental methodology {#apd-supplementary-methods}

# Reproducibility, accessibility & declarations (Gen-AI & word count)

<!-- BE note: taken out as we are submitting R file separately -->
<!-- Use: `knitr::purl("cs1-group07.rmd", documentation = 0)` to generate r file -->
<!-- Use: `tools::showNonASCIIfile("cs1-group07.rmd")` to debug -->
<!-- ## R Code Documentation -->
<!-- ```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
``` -->

## Reproducibility & accessibility

An accessible HTML version of this report is available via a public GitHub page:

- TBI

This report was created in R Markdown. The source code is open source and is
available via:

- TBI

Changes made to this document were tracked using Git and are also available via
the same repository (link TBI!). Please note that this commit history reflects
updates made to the project repository and is not a comprehensive timeline of
all contributions by group members.

## Generative AI Declaration

Do we want to include this?

<!--
Generative AI (GenAI) tools were used throughout this project to assist with
project planning, methodological validation, and debugging. In practice, these
tools functioned as an additional technical team member, providing immediate
feedback, troubleshooting code, and challenging statistical assumptions.

### Tools Used

Google Gemini 2.5 Pro (Deep Research), ChatGPT 5

### Prompts used

The GenAI tools were provided with the 'Coursework Group 7.pdf' and extracts
from our R code.

A non-exhaustive list of prompts used is shown below. We opted to include at
least one example of each _type_ of prompt used, rather than a list of all
prompts. For example, if we entered the prompts 'How can we put two ggplots side
by side?' and 'How to remove grey background on a ggplot', we would include only
the first of these in the list below, as both relate to plotting issues (& are
similar to 'querying' with a traditional search engine).

- "Can you help with outlining the steps for this project."
- "...the top of both graphs in r are slightly different. (Pasting R code.) Can
  this be fixed for the plot area?"
- "Help phrasing this in a simple and accessible way - remove any jargon &
  identify the key points"
- "How can this error be tracked down in an rmd file? ! Text line contains an
  invalid character. l.1 ^^@^^@..."
- "Are there specific assumptions for the Kruskal-Wallis test regarding variance
  and where is this explanation in Nonparametric Statistical Methods?"

### Use of GenAI outputs & subsequent revisions

The GenAI tools served as a "consultant" member of the group. Notably, the AI
output:

- Helped debug plotting issues.
- Highlighted potential statistical pitfalls, such as the "ANOVA trap"
  (normality violations) and the importance of ordering data cleansing steps
  correctly.
- Suggested appropriate non-parametric alternatives (Kruskal-Wallis,
  Mann-Whitney U) when diagnostic plots revealed that parametric assumptions
  were violated.
- Recommended specific R packages (nortest, e1071) and functions (ad.test,
  kruskal.test) best suited for each task.
- Commented on the structure of R code snippets and the report structure.

### Changes made:

All AI suggestions were critically reviewed and debated by the group before
implementation. For example:

- While the AI suggested code for complex layouts, the specific aesthetic
  choices and annotations were manually adjusted to ensure clarity.
- Where the AI proposed specific interpretations, these were cross-referenced
  with academic literature and statistics textbooks.
- The final R code for implementation was written and debugged by the group with
  AI snippets being treated as drafts rather than final solutions.

While GenAI was treated as a collaborator, the final analysis, statistical
interpretation, and the written content of this report were generated and
verified by the (human) group members. -->
